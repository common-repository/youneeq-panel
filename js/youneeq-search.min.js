var __assign=this&&this.__assign||Object.assign||function(e){for(var a,r=1,t=arguments.length;r<t;r++){a=arguments[r];for(var s in a)Object.prototype.hasOwnProperty.call(a,s)&&(e[s]=a[s])}return e},YouneeqSearchHandler=function(){function YouneeqSearchHandler(e,a){if(void 0===a&&(a=!0),!this||!this.init_all_data)throw'YouneeqSearchHandler() must be called with "new"';this.box=e,this.search={},this.search_type="article",this.no_results_msg="",this.next_msg="",this.prev_msg="",this.is_loading=!1,this.is_waiting_for_id=!1,this.results_count=0,YouneeqSearchHandler.instances.push(a?this.init_all_data().request(["first"]):this.init_all_data())}return Object.defineProperty(YouneeqSearchHandler.prototype,"page_count",{get:function(){return Math.ceil(this.results_count/("image"==this.search_type?12:10))},enumerable:!0,configurable:!0}),YouneeqSearchHandler.generate=function(){var e=jQuery("#youneeq-search, .youneeq-search, youneeq-search").get().sort(function(e,a){var r=jQuery(e).attr("data-yq-priority"),t=jQuery(a).attr("data-yq-priority");return r=r?parseInt(r):0,t=t?parseInt(t):0,r>t?1:r<t?-1:0});e.forEach(function(e){var a=jQuery(e),r=new YouneeqSearchHandler(e,!a.hasClass("yq-no-auto"));a.data("youneeqSearchHandler",r).on("yq:searchPopulatePrepare",{handler:r},function(e,a){e.data.handler.results_count=a&&a.numResults?a.numResults:0})})},YouneeqSearchHandler.prototype.refresh=function(e,a){void 0===e&&(e=[]),void 0===a&&(a=null),this.search={},this.init_all_data(a).request(e)},YouneeqSearchHandler.prototype.page=function(e){e>0&&e<=this.page_count&&(this.search.pageNumber=e,this.request(["change_page"]))},YouneeqSearchHandler.prototype.page_prev=function(){this.page("pageNumber"in this.search?this.search.pageNumber-1:1)},YouneeqSearchHandler.prototype.page_next=function(){this.page("pageNumber"in this.search?this.search.pageNumber+1:this.page_count)},YouneeqSearchHandler.prototype.page_first=function(){this.page(1)},YouneeqSearchHandler.prototype.page_last=function(){this.page(this.page_count)},YouneeqSearchHandler.prototype.request=function(e){if(void 0===e&&(e=[]),this.is_waiting_for_id){this.is_waiting_for_id=!1;var a=this;window.setTimeout(function(e){a.request(e)},1e3,e)}else if(!this.is_loading&&"domain"in this.search&&this.search.domain&&"search"in this.search){var r=YouneeqSearchHandler.SEARCH_HOST;switch(this.is_loading=!0,this.search_type){case"image":r+=YouneeqSearchHandler.SEARCH_IMAGE_PATH;break;case"article":default:r+=YouneeqSearchHandler.SEARCH_PATH}jQuery.ajax({url:r,crossDomain:!0,dataType:"jsonp",data:{json:JSON.stringify(this.search)}}).done(this._populate(e,"ajax_display"in this))}return this},YouneeqSearchHandler.prototype.display_page_selector=function(e){var a=jQuery('<div class="yq-search-page-container">').appendTo(this.box),r=1,t=1,s=this.page_count,n="pageNumber"in this.search?this.search.pageNumber:1;if(this.results_count){s<11?t=s:(r=n-4,t=n+5,r<1?(t-=r-1,r=1):t>s&&(r-=t-s,t=s)),1==n?a.append('<span class="yq-search-page-prev">'+this.prev_msg+"</span> "):a.append('<a class="yq-search-page-prev" href="#">'+this.prev_msg+"</a> ");for(var i=r;i<=t;i++)i==n?a.append('<span class="yq-search-page-selector selected">'+i+"</span> "):a.append('<a class="yq-search-page-selector" href="#" data-yq-page="'+i+'">'+i+"</a> ");s==n?a.append('<span class="yq-search-page-next">'+this.next_msg+"</span>"):a.append('<a class="yq-search-page-next" href="#">'+this.next_msg+"</a>")}e.indexOf("first")!=-1&&jQuery(this.box).on("click",".yq-search-page-container a",{handler:this},function(e){e.preventDefault();var a=jQuery(e.currentTarget),r=e.data.handler;a.hasClass("yq-search-page-prev")?r.page_prev():a.hasClass("yq-search-page-next")?r.page_next():r.page(parseInt(a.data("yqPage")))})},YouneeqSearchHandler.prototype.display=function(e,a){if(e){if("numResults"in e&&!e.numResults)jQuery(this.box).text(this.no_results_msg.replace("%1",this.search.search));else{var r=[],t=!1,s=jQuery(this.box).empty();e.stories?r=e.stories:e.images&&(r=e.images,t=!0);for(var n=0,i=r.length;n<i;n++){var o=r[n].contentId?r[n].contentId:"",c=r[n].title?r[n].title:"",h=r[n].url?r[n].url:"",u=r[n].imageUrl?r[n].imageUrl:"",p=t?r[n].caption?r[n].caption:"":r[n].description?r[n].description:"";t?s.append('<a href="'+h+'" class="yqs-article-image" data-yq-id="'+o+'" data-yq-title="'+c+'" data-yq-url="'+h+'">\n    '+(u?'<img class="yq-image" src="'+u+'" alt="'+c+'" title="'+p+'" />':"")+"\n</a>"):s.append('<div class="yqs-article" data-yq-id="'+o+'" data-yq-title="'+c+'" data-yq-url="'+h+'">\n    <a href="'+h+'">\n        '+(u?'<img class="yq-image" src="'+u+'" alt="'+c+'" />':"")+'\n        <h3 class="yq-title">'+c+"</h3>\n     </a>\n     "+(p?'<p class="yq-desc">'+p+"</p>":"")+"\n</div>")}}this.display_page_selector(a)}},YouneeqSearchHandler.prototype.init_all_data=function(e){void 0===e&&(e=null);var a=this.get_args();return this.init_request_data(a).init_search_data(a,e).init_method_overrides(a)},YouneeqSearchHandler.prototype.get_args=function(){for(var e={},a={},r={},t=null,s=0,n=this.box.attributes.length;s<n;s++){var i=this.box.attributes[s].name;"data-yq-"==i.substr(0,8)&&(e[i.substr(8).replace(/-/g,"_")]=this.box.attributes[s].value)}return"search_function"in e&&e.search_function in window&&("function"==typeof e.search_function?a=window[e.search_function](this):"object"==typeof e.search_function&&(a=window[e.search_function])),"search_form"in a&&a.search_form?t=a.search_form:"search_form_id"in e&&e.search_form_id&&(t="#"+e.search_form_id),t&&jQuery(t).submit({self:this},function(e){e.preventDefault(),e.data.self.refresh()}).serializeArray().forEach(function(e){if(e.value)switch(e.name){case"search":case"s":case"q":case"query":r.search=e.value;break;default:r[e.name]=e.value}}),__assign({},e,r,a)},YouneeqSearchHandler.prototype.init_request_data=function(e){return"search_type"in e&&(this.search_type=e.search_type),"no_results_msg"in e?this.no_results_msg=e.no_results_msg:this.no_results_msg="No results found","next_msg"in e?this.next_msg=e.next_msg:this.next_msg="Next","prev_msg"in e?this.prev_msg=e.prev_msg:this.prev_msg="Prev",this},YouneeqSearchHandler.prototype.init_search_data=function(e,a){return void 0===a&&(a=null),null!==a?this.search.search=a:this.init_search_query(e),this.process_search_param(e,"domain",null,"search_domain")||(this.search.domain=window.location.hostname),this.init_user_id(e),this.process_search_param(e,"contentInfo",Boolean,"search_content_info"),this.process_search_param(e,"endDate",YouneeqSearchHandler.process_date_string,"search_end_date"),this.process_search_param(e,"maxArticleAge",parseInt,"search_max_age"),this.process_search_param(e,"personalized",Boolean,"search_personalized"),this.process_search_param(e,"pageNumber",parseInt,"search_page_number")||(this.search.pageNumber=1),this.process_search_param(e,"startDate",YouneeqSearchHandler.process_date_string,"startdate","search_start_date"),this.process_search_param(e,"killPromoteInfo",Boolean,"search_kp_info"),this.process_search_param(e,"orderBy",null,"search_order_by")||(this.search.orderBy="relevance"),this},YouneeqSearchHandler.prototype.init_search_query=function(e){if(!this.process_search_param(e,"search",null,"search_query")){var a={},r="";if(window.location.search.substr(1).split("&").forEach(function(e){var r=e.split("=");a[r[0]]=r.length>1&&r[1]}),"search_param"in e&&e.search_param in e?this.search.search=e[e.search_param]:"search_param"in e&&e.search_param in a?r=a[e.search_param]:"s"in a?r=a.s:"search"in a?r=a.search:"query"in a?r=a.query:"q"in a&&(r=a.q),r)try{this.search.search=decodeURIComponent(r.replace(/\+/," "))}catch(e){}}},YouneeqSearchHandler.prototype.init_user_id=function(e){if(!this.process_search_param(e,"userId",null,"search_user_id")){var a=null,r=!0;try{a=localStorage.getItem("yq_session")}catch(e){r=!1}if(a&&a.length>=8)this.search.userId=a;else if("yqs"in window&&"string"==typeof yqs&&yqs.length>=8)this.search.userId=yqs;else{this.is_waiting_for_id=!0;var t=this;jQuery("<span></span>").load(YouneeqSearchHandler.SESSION_ID_FILE,function(e){e.length>=8&&(t.search.userId=e,r&&localStorage.setItem("yq_session",e)),t.is_waiting_for_id=!1})}}},YouneeqSearchHandler.prototype.init_method_overrides=function(e){return e.ajax_display_function?this.ajax_display=window[e.ajax_display_function]:e.display_function&&(this.display=window[e.display_function]),this},YouneeqSearchHandler.prototype.process_search_param=function(e,a,r){for(var t=[],s=3;s<arguments.length;s++)t[s-3]=arguments[s];if(a in e){r||(r=function(e){return e});try{return this.search[a]=r(e[a]),!0}catch(e){}}for(var n=0,i=t.length;n<i;n++)if(t[n]in e){r||(r=function(e){return e});try{return this.search[a]=r(e[a]),!0}catch(e){}}return!1},YouneeqSearchHandler.process_date_string=function(e){var a="";try{a=(e instanceof Date?e:new Date(e)).toISOString();try{a=a.replace("Z",jzTimezoneDetector.determine_timezone().timezone.utc_offset)}catch(e){}}catch(e){}return a},YouneeqSearchHandler.prototype._populate=function(e,a){var r=this;return void 0===a&&(a=!1),a?function(a){r.is_loading=!1;var t=jQuery(r.box);t.trigger("yq:searchPopulatePrepare",[a,e]),r.ajax_display(a,e,function(a){t.trigger("yq:searchPopulateAttach",[a,e])})}:function(a){r.is_loading=!1;var t=jQuery(r.box);t.trigger("yq:searchPopulatePrepare",[a,e]),r.display(a,e),t.trigger("yq:searchPopulateAttach",[a,e])}},YouneeqSearchHandler}();YouneeqSearchHandler.instances=[],YouneeqSearchHandler.SEARCH_HOST="http://search.youneeq.ca/",YouneeqSearchHandler.SEARCH_PATH="api/search",YouneeqSearchHandler.SEARCH_IMAGE_PATH="api/imagesearch",YouneeqSearchHandler.SESSION_ID_FILE="http://api.youneeq.ca/app/sessionid",jQuery(function(){jQuery("html.yq-no-auto").length||YouneeqSearchHandler.generate()});
//# sourceMappingURL=../youneeq-search.min.js.map